<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Aircraft Engine VR Visualization (A-Frame)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame CDN for easy inclusion -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Optional: A-Frame Extras for more advanced controls like movement-controls -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <style>
        /* Basic styling for the body to ensure full screen */
        body { margin: 0; overflow: hidden; }
        /* Style for the loading indicator */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #333;
            color: white;
            display: flex;
            flex-direction: column; /* Allow text and potential progress bar */
            justify-content: center;
            align-items: center;
            font-family: 'Inter', sans-serif;
            font-size: 2em;
            z-index: 9999;
        }
        #loading-text {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading screen to show while assets are being loaded -->
    <div id="loading-screen">
        <div id="loading-text">Loading VR Experience...</div>
        <!-- You could add a progress bar here later -->
    </div>

    <!-- The A-Frame scene where all 3D content resides -->
    <!-- Added renderer="ar: true" for passthrough on Quest devices -->
    <a-scene background="color: #ECECEC" loading-screen="enabled: false" renderer="ar: true">
        <!--
            Assets management:
            Define all your assets (3D models, textures, sounds) here.
            They will be preloaded before the scene starts, improving performance.
            Replace 'placeholder-engine.glb' with the path to your actual engine model.
        -->
        <a-assets timeout="10000">
            <!-- Example of loading a GLTF model. You would replace this with your engine model. -->
            <!-- For a real engine, you'd use your actual .glb or .gltf file path -->
            <a-asset-item id="engine-model" src="https://cdn.glitch.global/0638e4a9-6e3e-436f-821b-c19d4b0f983a/turbine_engine.glb?v=1708681123456"></a-asset-item>
            <!-- You can add other assets like textures or sounds here -->
            <img id="info-panel-texture" src="https://placehold.co/512x256/000000/FFFFFF?text=Engine+Info" crossorigin="anonymous">
        </a-assets>

        <!--
            Camera and Player Rig:
            This sets up the user's viewpoint and interaction capabilities.
            - `wasd-controls`: Enables movement using W, A, S, D keys (desktop) or joystick (VR).
            - `look-controls`: Enables looking around using mouse (desktop) or head tracking (VR).
            - `movement-controls`: (From aframe-extras) Provides more robust locomotion options.
            - `position`: Sets the initial position of the user in the scene.
        -->
        <a-entity id="rig" movement-controls="speed: 0.1; fly: false" position="0 1.6 3">
            <a-camera look-controls="pointerLockEnabled: true">
                <!-- Cursor for interaction: A simple ring that appears when pointing -->
                <a-cursor raycaster="objects: .collidable" color="#FF0000" fuse="false"></a-cursor>
            </a-camera>
            <!--
                Updated: Using hand-controls for both controller model and integrated raycasting.
                This should improve alignment and click detection.
                - `hand-controls`: Automatically loads the correct controller model for the platform.
                - `raycaster`: Attached directly to hand-controls for integrated interaction.
                  `showLine: true` for debugging (makes the laser visible).
                  `far: 10` ensures the ray reaches objects up to 10 units away.
                - `line`: Visualizes the raycaster's line.
            -->
            <a-entity hand-controls="hand: right" raycaster="objects: .collidable; showLine: true; far: 10" line="color: red; opacity: 0.75">
            </a-entity>
            <a-entity hand-controls="hand: left" raycaster="objects: .collidable; showLine: true; far: 10" line="color: blue; opacity: 0.75">
            </a-entity>
        </a-entity>

        <!--
            Aircraft Engine Model:
            Load your GLTF/GLB model here.
            - `gltf-model`: Component to load GLTF/GLB assets.
            - `position`, `rotation`, `scale`: Adjust these to place and size your model correctly.
            - `class="collidable"`: Marks the model as interactable for the raycaster/cursor.
            - `id="engine"`: Gives it a unique ID for scripting.
        -->
        <a-entity id="engine"
                  gltf-model="#engine-model"
                  position="0 0.5 -2"
                  rotation="0 45 0"
                  scale="1 1 1"
                  class="collidable">
            <!-- You can add child entities here to represent specific engine components -->
            <a-box id="compressor-section"
                   position="0.5 0 0"
                   width="0.8" height="0.8" depth="0.8"
                   color="#4CAF50"
                   opacity="0.5"
                   visible="false"
                   class="collidable">
                <a-text value="Compressor Section" position="0 0 0.45" align="center" color="white"></a-text>
            </a-box>
            <a-box id="turbine-section"
                   position="-0.5 0 0"
                   width="0.8" height="0.8" depth="0.8"
                   color="#FF9800"
                   opacity="0.5"
                   visible="false"
                   class="collidable">
                <a-text value="Turbine Section" position="0 0 0.45" align="center" color="white"></a-text>
            </a-box>
        </a-entity>

        <!-- New: Four clickable cubes -->
        <a-box id="cube-1" position="-2 1.6 -3" color="#FF5733" class="collidable" interactive-component></a-box>
        <a-box id="cube-2" position="2 1.6 -3" color="#33FF57" class="collidable" interactive-component></a-box>
        <a-box id="cube-3" position="-3 1.6 0" color="#3357FF" class="collidable" interactive-component></a-box>
        <a-box id="cube-4" position="3 1.6 0" color="#FF33FF" class="collidable" interactive-component></a-box>

        <!--
            Ground Plane:
            A simple plane for the user to stand on and provide a sense of scale.
        -->
        <a-plane position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>

        <!--
            Lighting:
            Essential for making your 3D model visible and look good.
            - `ambient-light`: Provides general, non-directional illumination.
            - `directional-light`: Simulates sunlight, creating shadows.
        -->
        <a-entity light="type: ambient; color: #BBBBBB"></a-entity>
        <a-entity light="type: directional; color: #FFFFFF; intensity: 0.8" position="-1 1 1"></a-entity>

        <!--
            Interactive Info Panel (initially hidden)
            This panel will appear when a component is interacted with.
        -->
        <a-entity id="info-panel"
                  position="0 1.6 -1"
                  visible="false"
                  geometry="primitive: plane; width: 2; height: 1"
                  material="src: #info-panel-texture; transparent: true; opacity: 0.9"
                  text="value: Select a component for details.; align: center; width: 1.8; wrapCount: 20; color: #333">
            <a-box class="collidable"
                   position="0.9 0.4 0.05"
                   width="0.2" height="0.2" depth="0.05"
                   color="#E91E63"
                   event-set__click="visible: false"
                   text="value: X; align: center; width: 0.2; wrapCount: 1; color: white">
            </a-box>
        </a-entity>

        <!-- JavaScript for interaction logic -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const loadingScreen = document.getElementById('loading-screen');
                const loadingText = document.getElementById('loading-text');
                const scene = document.querySelector('a-scene');
                const infoPanel = document.getElementById('info-panel');
                const infoPanelText = infoPanel.querySelector('a-text');

                // Function to update loading text
                function updateLoadingText(message) {
                    loadingText.textContent = message;
                }

                // Hide loading screen once the scene is loaded
                scene.addEventListener('loaded', function () {
                    loadingScreen.style.display = 'none';
                    console.log('A-Frame scene loaded!');
                });

                // Listen for asset loading errors
                const assets = document.querySelector('a-assets');
                assets.addEventListener('asset-load-error', function (event) {
                    const assetId = event.detail.id || event.detail.src;
                    updateLoadingText(`Error loading asset: ${assetId}. Please check the URL and ensure CORS is configured.`);
                    console.error('Asset load error:', event.detail);
                });

                // Custom component for basic interaction (e.g., clicking on a component)
                AFRAME.registerComponent('interactive-component', {
                    init: function () {
                        const el = this.el; // Reference to the entity this component is attached to

                        el.addEventListener('click', function (evt) {
                            const componentId = el.id;
                            let infoText = 'No information available.';

                            // Determine information based on the clicked component
                            if (componentId === 'engine') {
                                infoText = 'This is the main aircraft engine model. Explore its internal components!';
                            } else if (componentId === 'compressor-section') {
                                infoText = 'The compressor section compresses air before it enters the combustion chamber.';
                            } else if (componentId === 'turbine-section') {
                                infoText = 'The turbine section extracts energy from the hot exhaust gases to drive the compressor.';
                            } else if (componentId.startsWith('cube-')) { // Check for the new cubes
                                infoText = 'Hello!';
                            }

                            // Update and show the info panel
                            infoPanelText.setAttribute('value', infoText);
                            infoPanel.setAttribute('visible', true);
                            // Position the info panel relative to the camera for better visibility
                            const camera = document.querySelector('a-camera');
                            const cameraWorldPos = camera.object3D.getWorldPosition(new THREE.Vector3());
                            const cameraWorldRot = camera.object3D.getWorldQuaternion(new THREE.Quaternion());

                            // Position the panel slightly in front of the camera
                            const direction = new THREE.Vector3(0, 0, -1);
                            direction.applyQuaternion(cameraWorldRot);
                            direction.multiplyScalar(1.5); // Distance in front of camera
                            infoPanel.object3D.position.copy(cameraWorldPos).add(direction);

                            // Make the panel face the camera
                            infoPanel.object3D.lookAt(cameraWorldPos);
                        });

                        // Optional: Add hover effects
                        el.addEventListener('mouseenter', function () {
                            // Example: Change color or scale on hover
                            // el.setAttribute('material', 'color', '#AA00AA');
                        });
                        el.addEventListener('mouseleave', function () {
                            // Example: Revert color or scale
                            // el.setAttribute('material', 'color', '#4CAF50');
                        });
                    }
                });

                // Apply the interactive-component to the engine and its sub-components
                document.getElementById('engine').setAttribute('interactive-component', '');
                document.getElementById('compressor-section').setAttribute('interactive-component', '');
                document.getElementById('turbine-section').setAttribute('interactive-component', '');

                // Apply the interactive-component to the new cubes
                document.getElementById('cube-1').setAttribute('interactive-component', '');
                document.getElementById('cube-2').setAttribute('interactive-component', '');
                document.getElementById('cube-3').setAttribute('interactive-component', '');
                document.getElementById('cube-4').setAttribute('interactive-component', '');


                // Hide the info panel when the 'X' button on the panel is clicked
                infoPanel.querySelector('a-box').addEventListener('click', function() {
                    infoPanel.setAttribute('visible', false);
                });
            });
        </script>
    </a-scene>
</body>
</html>
